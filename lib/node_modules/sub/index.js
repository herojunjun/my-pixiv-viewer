var electron = require('electron');
const ipcRenderer = electron.ipcRenderer;

var MainViewer = function(filepaths) {
    if (!(this instanceof MainViewer)) {
        return new MainViewer();
    }
    this.current_illust_id = 0;
    this.viewer = document.body;
    this.title = document.getElementById("title");
    this.caption = document.getElementById("caption");
    this.tags = document.getElementById("tags-container");
    this.comments = document.getElementById("comment-list");
};

MainViewer.prototype.showCaption = function(innerHTML) {
    this.caption.innerHTML = innerHTML;
};

var mainViewer = new MainViewer();

var parsePixiv = function(body) {
    {
        var main = (new DOMParser).parseFromString(body, "text/html").getElementsByClassName("cool-work-main");
        console.log(main);
        for (var i = 0; i < main[0].childNodes.length; i++) {
            var node = main[0].childNodes[i];
            if (node.id.indexOf("caption_long") != -1) {
                console.log(node.id);
                mainViewer.showCaption(node.innerHTML);
                break;
            }
        }
    } {
        var main = (new DOMParser).parseFromString(body, "text/html").title;
        mainViewer.title.innerHTML = main;
    } {
        var main = (new DOMParser).parseFromString(body, "text/html").getElementsByClassName("tags-container");
        console.log(main);
        mainViewer.tags.innerHTML = main[0].innerHTML;
    } {
        var main = (new DOMParser).parseFromString(body, "text/html").getElementsByClassName("comment-list");
        console.log(main);
        mainViewer.comments.innerHTML = main[0].innerHTML;
    }
};

var requestPixiv = function(illust_id) {
    const request = new XMLHttpRequest();
    request.open("GET", ["https://www.pixiv.net/member_illust.php?mode=medium&illust_id=", illust_id].join(""));
    request.onload = function() {
        parsePixiv(request.responseText)
    };
    request.onerror = function() {
        console.error("通信エラー")
    };
    request.send();
};

ipcRenderer.on('illust_id', function(ev, message) {
    console.log(message + "受け取った");
    if (mainViewer.current_illust_id == message) {
        return;
    }
    mainViewer.current_illust_id = message;
    requestPixiv(message);
});
