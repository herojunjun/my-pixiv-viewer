let electron = require('electron');
const ipcRenderer = electron.ipcRenderer;

const SubViewer = function()
{
    if (!(this instanceof SubViewer))
    {
        return new SubViewer();
    }
    this.current_illust_id = 0;
    this.viewer = document.body;
    this.title = document.getElementById('title');
    this.caption = document.getElementById('caption');
    this.tags = document.getElementById('tags-container');
    this.comments = document.getElementById('comment-list');
};

SubViewer.prototype.showCaption = function(innerHTML)
{
    this.caption.innerHTML = innerHTML;
};

let mainViewer = new SubViewer();

let parsePixiv = function(body)
{
    const parsedBody = (new DOMParser).parseFromString(body, 'text/html');
    {
        const main = parsedBody.getElementsByClassName('cool-work-main');
        console.log(main);
        for (let i = 0; i < main[0].childNodes.length; i++)
        {
            let node = main[0].childNodes[i];
            if (node.id.indexOf('caption_long') !== -1)
            {
                console.log(node.id);
                mainViewer.showCaption(node.innerHTML);
                break;
            }
        }
    } {
        mainViewer.title.innerHTML = parsedBody.title;
    } {
        const main = parsedBody.getElementsByClassName('tags-container');
        console.log(main);
        mainViewer.tags.innerHTML = main[0].innerHTML;
    } {
        const main = parsedBody.getElementsByClassName('comment-list');
        console.log(main);
        mainViewer.comments.innerHTML = main[0].innerHTML;
    }
};

let requestPixiv = function(illust_id)
{
    const request = new XMLHttpRequest();
    request.open('GET', ['https://www.pixiv.net/member_illust.php?mode=medium&illust_id=', illust_id].join(''));
    request.onload = function()
    {
        parsePixiv(request.responseText);
    };
    request.onerror = function()
    {
        console.error('通信エラー');
    };
    request.send();
};

ipcRenderer.on('illust_id', function(ev, message)
{
    console.log(message + '受け取った');
    if (mainViewer.current_illust_id === message)
    {
        return;
    }
    mainViewer.current_illust_id = message;
    requestPixiv(message);
});
