let electron = require('electron');
let fileUtil = require('main/fileUtil');

const ipcRenderer = electron.ipcRenderer;

const MainViewer = function()
{
    if (!(this instanceof MainViewer))
    {
        return new MainViewer();
    }
    this.current = 0;
    this.filepaths = [];
    this.viewer = document.body;
    this.img = document.getElementById('main-image');
    this.mode = true;
    this.intervalId = -1;
};

MainViewer.prototype.play = function()
{
    if (this.mode)
    {
        if (this.intervalId === -1)
        {
            const playUgoira = function(viewer)
            {
                let next = viewer.current + 1;

                if (viewer.checkFirstPage(next))
                {
                    for (let i = viewer.current; 0 <= i; i--)
                    {
                        if (viewer.checkFirstPage(i))
                        {
                            viewer.current = i;
                            viewer.change();
                            break;
                        }
                    }
                }
                else
                {
                    viewer.current = next;
                    viewer.change();
                }
            };

            this.intervalId = setInterval(playUgoira, 1000 / 30, this);
        }
        else
        {
            clearTimeout(this.intervalId);
            this.intervalId = -1;
        }
    }
};

MainViewer.prototype.check = function(no)
{
    return 0 <= no && no < this.filepaths.length;
};

MainViewer.prototype.checkFirstPage = function(no)
{
    let filepath = this.filepaths[no];
    let reg = /\/[0-9]+_[0-9]+_p[0]+\./;
    return reg.test(filepath);
};

MainViewer.prototype.up = function()
{
    if (this.mode)
    {
        if (this.check(this.current - 1))
        {
            this.current = this.current - 1;
            this.change();
        }
    }
    else
    {
        window.scrollBy(0, -60);
    }
};

MainViewer.prototype.down = function()
{
    if (this.mode)
    {
        if (this.check(this.current + 1))
        {
            this.current = this.current + 1;
            this.change();
        }
    }
    else
    {
        window.scrollBy(0, 60);
    }
};

MainViewer.prototype.right = function()
{
    if (this.mode)
    {
        for (let i = this.current - 1; 0 <= i; i--)
        {
            if (this.checkFirstPage(i))
            {
                this.current = i;
                this.change();
                break;
            }
        }
    }
    else
    {
        window.scrollBy(60, 0);
    }
};

MainViewer.prototype.left = function()
{
    if (this.mode)
    {
        for (let i = this.current + 1; i < this.filepaths.length; i++)
        {
            if (this.checkFirstPage(i))
            {
                this.current = i;
                this.change();
                break;
            }
        }
    }
    else
    {
        window.scrollBy(-60, 0);
    }
};

MainViewer.prototype.defaultSize = function()
{
    if (!this.img.classList.contains('default'))
    {
        this.mode = true;
        this.img.classList.add('default');
        this.viewer.classList.remove('fullscreen');
    }
};

MainViewer.prototype.toggleFullSize = function()
{
    if (this.img.classList.contains('default'))
    {
        this.mode = false;
        this.img.classList.remove('default');
        this.viewer.classList.add('fullscreen');
    }
    else
    {
        this.defaultSize();
    }
};

MainViewer.prototype.change = function()
{
    let fullpath = this.filepaths[this.current];
    console.log(fullpath);
    this.img.setAttribute('src', fullpath);
    this.defaultSize();
    ipcRenderer.send('show_illust_id', fullpath.match(/[\d]+_([\d]+)_p[\d]+/)[1]);
};

let mainViewer = new MainViewer();

let mainImage = {
    up: function()
    {
        mainViewer.up();
    },
    down: function()
    {
        mainViewer.down();
    },
    right: function()
    {
        mainViewer.right();
    },
    left: function()
    {
        mainViewer.left();
    },
    defaultSize: function()
    {
        mainViewer.defaultSize();
    },
    play: function()
    {
        mainViewer.play();
    },
    fullSize: function()
    {
        mainViewer.toggleFullSize();
    },
};

module.exports = mainImage;

ipcRenderer.on('main_directory', function(ev, message)
{
    console.log(message + '受け取った');

    fileUtil.getImageFileList(message, function(err, matches)
    {
        if (err)
        {
            console.error(err);
            return;
        }

        matches.sort();
        mainViewer.filepaths = matches;
        mainViewer.change();
    });
});
